# Innocenti Risk Management - Project Context

## What This Is

A field engineering **enablement kit** for Elastic, demonstrating a "Full Chain" search pipeline using **Jina AI models** on **Elastic Inference Service (EIS)**. The scenario: a fictional law firm ("Innocenti & Associates") needs precision search over the **EU AI Act**.

**Audience:** Internal Elastic field engineers and SAs. They'll present this to C-Level/VP audiences.

## Two-Part Structure

| Part | Location | Language | Purpose |
|------|----------|----------|---------|
| Data Pipeline | `notebooks/` | Python / Jupyter | Ingest, index, and demonstrate reranking |
| Interactive Demo | `ui/` | Next.js 14 (TypeScript) | Polished search + agent UI for live demos |

Both parts operate on the **same Elasticsearch index**: `search-eu-ai-act-demo`.

## File Tree

```
├── notebooks/
│   ├── 01_ingest.ipynb         # PDF -> JSON via Jina Reader
│   ├── 02_index.ipynb          # Index with semantic_text + EIS inference endpoints
│   ├── 03_rerank.ipynb         # Listwise reranking demo
│   ├── utils/
│   │   ├── credentials.py      # Shared credential management (loads ui/.env.local as primary)
│   │   ├── parsing.py          # parse_articles() — extracted from NB 01 for testability
│   │   ├── comparison.py       # build_comparison() — extracted from NB 03 for testability
│   │   ├── inference.py        # verify_embedding_endpoint / create_reranker_inference
│   │   ├── reader.py           # fetch_with_jina_reader() — Jina Reader API with retry
│   │   └── colab_setup.py      # setup_environment() — shared Colab/local detection
│   └── tests/                  # pytest suite (46 unit + 3 smoke + 4 integration)
│       ├── conftest.py         # Shared fixtures, sample data, mock helpers
│       ├── fixtures/           # sample_jina_response.md, sample_articles.json
│       ├── test_credentials.py # Credential fallback chain, naming, ES client
│       ├── test_parsing.py     # Article parsing + ranking comparison
│       ├── test_inference.py   # Inference endpoint creation + error handling
│       ├── test_reader.py      # Jina Reader retry logic
│       ├── test_notebooks_smoke.py       # Notebook execution with mocked services
│       └── test_notebooks_integration.py # Full pipeline against real services
├── data/
│   └── eu_ai_act_clean.json    # Generated by notebook 01
│
├── ui/
│   ├── app/
│   │   ├── page.tsx            # Main page — orchestrates search, VLM, and agent modes
│   │   ├── layout.tsx
│   │   ├── globals.css         # Dark theme + agent markdown styles
│   │   └── api/
│   │       ├── search/route.ts          # Elasticsearch semantic search + reranking
│   │       ├── vision/route.ts          # Jina VLM diagram auditor (multipart/form-data)
│   │       ├── vision/warmup/route.ts   # VLM cold-start warmup endpoint
│   │       ├── agent/route.ts           # SSE proxy to Kibana Agent Builder
│   │       └── agent/followups/route.ts # LLM-generated follow-up questions
│   ├── components/
│   │   ├── SearchBar.tsx       # Text input + image upload button
│   │   ├── ResultsList.tsx     # Renders search results
│   │   ├── ResultCard.tsx      # Individual result card
│   │   ├── DeepAnalysisButton.tsx  # Triggers reranking
│   │   ├── VlmAuditPanel.tsx   # Collapsible VLM analysis display
│   │   ├── AgentChat.tsx       # Chat UI with thinking steps, tool calls, markdown
│   │   ├── ModeToggle.tsx      # Switch between Search and Agent modes
│   │   ├── EuAiActModal.tsx    # Info modal about the EU AI Act
│   │   ├── Header.tsx          # App header
│   │   ├── LanguageToggle.tsx  # EN/DE language toggle (controlled)
│   │   └── TomModal.tsx       # Tom Innocenti bio modal
│   ├── lib/
│   │   ├── elasticsearch.ts    # ES client singleton + search functions
│   │   └── kibana.ts           # Kibana URL derivation + auth headers
│   ├── scripts/
│   │   ├── setup-demo-index.ts # Creates index, fetches EU AI Act (EN+DE), bulk indexes
│   │   └── setup-agent.ts      # Provisions Agent Builder tool + agent via Kibana API
│   ├── __tests__/
│   │   ├── unit/               # Vitest unit tests
│   │   │   ├── components/     # 11 component test files
│   │   │   ├── api/            # 4 API route test files (search, agent, vision, followups)
│   │   │   └── lib/            # 2 library test files
│   │   └── e2e/                # Playwright E2E tests (25 tests)
│   │       ├── search-flow.spec.ts
│   │       ├── agent-flow.spec.ts
│   │       ├── language-toggle.spec.ts
│   │       └── modals.spec.ts
│   ├── vitest.config.ts        # Vitest config (jsdom, React plugin, path aliases)
│   ├── vitest.setup.ts         # Test setup (cleanup, scrollTo mock, fetch stub)
│   ├── playwright.config.ts    # Playwright config (chromium, webServer)
│   ├── types/index.ts          # Shared TypeScript interfaces
│   ├── .env.local              # Credentials (never committed)
│   ├── .env.local.example      # Template for credentials
│   └── package.json
│
├── .github/workflows/
│   └── test-notebooks.yml      # CI: runs notebook unit + smoke tests on push/PR
├── requirements.txt            # Python dependencies
└── README.md                   # Consolidated project documentation
```

## Tech Stack

- **Framework:** Next.js 14 (App Router)
- **Styling:** Tailwind CSS, dark mode, slate grey + gold accent palette
- **Icons:** Lucide React
- **Elasticsearch:** `@elastic/elasticsearch` JS client, `semantic_text` field type
- **Markdown:** `react-markdown` (for agent chat responses)
- **Env:** `dotenv` (for setup scripts)
- **Tone:** Enterprise-grade, sophisticated, "High-End Legal / Risk Dashboard"

## Three UI Modes

### 1. Text Search (default)
- User types a query or clicks a sample query pill
- Calls `POST /api/search` -> `elasticsearch.ts` -> `semantic` query on `text` field
- "Deep Analysis" button triggers reranking via `retrievers` API with `text_similarity_reranker`
- Shows before/after comparison with movement indicators

### 2. Visual Diagram Auditor
- User clicks image icon -> uploads architecture diagram
- `POST /api/vision` -> converts to Base64 -> sends to Jina VLM at `https://api-beta-vlm.jina.ai/v1/chat/completions`
- VLM returns data-flow analysis -> displayed in collapsible `VlmAuditPanel`
- Analysis text is automatically piped into `/api/search` as the query

### 3. Agent Chat
- User toggles to "Agent" mode via `ModeToggle`
- Chat messages go through `POST /api/agent` -> Kibana `converse/async` endpoint (SSE)
- Agent uses `eu-ai-act-search` tool (esql type) to query the same ES index
- `AgentChat.tsx` renders thinking steps, tool calls/results (collapsible), and markdown responses
- After each response, `/api/agent/followups` generates contextual follow-up question pills via the LLM connector
- Image uploads go through Jina VLM first, then the VLM analysis is passed to the agent as context

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `ELASTICSEARCH_URL` | Yes* | ES endpoint URL (standard for Serverless) |
| `ELASTIC_CLOUD_ID` | Alt* | Classic Cloud deployment ID (alternative to URL) |
| `ELASTIC_API_KEY` | Yes | API key with index/search/manage permissions |
| `JINA_API_KEY` | Yes | Jina AI API key (used for VLM + EIS setup) |
| `AGENT_CONNECTOR_ID` | For Agent | LLM connector ID for Agent Builder (e.g. `OpenAI-GPT-4-1-Mini`) |
| `KIBANA_URL` | No | Override — auto-derived from `ELASTICSEARCH_URL` by swapping `.es.` -> `.kb.` |

*One of `ELASTICSEARCH_URL` or `ELASTIC_CLOUD_ID` is required. Prefer `ELASTICSEARCH_URL` for Serverless.

## Naming Conventions

| Resource | ID / Name |
|----------|-----------|
| Elasticsearch index | `search-eu-ai-act-demo` |
| Embedding inference endpoint | `.jina-embeddings-v5-text-small` (built-in on Serverless) |
| Reranker inference endpoint | `jina-reranker-v3-demo` |
| Agent Builder agent | `eu-ai-act-compliance-agent` |
| Agent Builder tool | `eu-ai-act-search` (type: `esql`, index: `search-eu-ai-act-demo`) |

## Key Architectural Patterns

### Elasticsearch
- Uses `semantic_text` field type — embedding happens at ingest via EIS, not at query time
- Reranking uses the `retrievers` API: `text_similarity_reranker` wrapping a `standard` retriever with a `semantic` query
- ES client supports both `ELASTICSEARCH_URL` (node) and `ELASTIC_CLOUD_ID` (cloud)

### Kibana / Agent Builder
- `lib/kibana.ts` derives Kibana URL by swapping `.es.` to `.kb.` in the ES URL
- Auth headers: `Authorization: ApiKey <key>`, `kbn-xsrf: true`, `x-elastic-internal-origin: kibana`
- Agent converse payload uses `input` (not `message`) as the field name for the user's text
- SSE stream format from Kibana: `event: <type>` line + `data: {"data": {...}}` (double envelope)
- Event types: `message_chunk`, `conversation_id_set`, `tool_call`, `tool_progress`, `tool_result`, `error`

### VLM
- **Beta endpoint**: `https://api-beta-vlm.jina.ai/v1/chat/completions` (NOT the standard `api.jina.ai`)
- Images sent as Base64 data URIs in the `image_url` content part
- Cold start: ~45 seconds after idle. Route retries 3 times with 15s/30s delays, returns `coldStart: true` on exhaustion

### Agent Chat UI (`AgentChat.tsx`)
- Two-level collapsible steps panel: outer panel collapses all thinking steps, inner rows expand individual tool calls/results to show JSON payloads
- Spinner lifecycle: `Loader2` animates only on the last step when message status != `complete`; completed steps show static `CheckCircle2`
- Agent responses rendered with `react-markdown` inside `.agent-markdown` CSS class (scoped dark-theme styles in `globals.css`)

## npm Scripts (run from `ui/`)

| Command | Description |
|---------|-------------|
| `npm run setup` | Create ES index + load EU AI Act data (idempotent, both EN + DE) |
| `npm run setup:de` | Ingest only German articles (skips EN) |
| `npm run setup:agent` | Provision Agent Builder tool + agent via Kibana API (idempotent) |
| `npm run dev` | Start Next.js dev server |
| `npm run build` | Production build |
| `npm test` | Run Vitest unit tests (123 tests) |
| `npm run test:watch` | Run Vitest in watch mode |
| `npm run test:e2e` | Run Playwright E2E browser tests (25 tests) |
| `npm run test:all` | Run both unit + E2E tests |

## Makefile Targets (run from project root)

| Target | Description |
|--------|-------------|
| `make test-nb-unit` | Notebook unit tests only (46 tests, <1s) |
| `make test-nb-smoke` | Notebook smoke tests with mocked services (3 tests, ~4s) |
| `make test-nb-integration` | Notebook integration tests against real services (opt-in, ~3-5 min) |
| `make test-nb-all` | All notebook tests except integration |
| `make test-ui-unit` | UI Vitest unit tests |
| `make test-ui-e2e` | UI Playwright E2E tests |
| `make test-ui-all` | All UI tests |
| `make test-all` | Everything: notebook + UI tests |

## Test Suite

The project has comprehensive test coverage across notebooks and the UI.

### Notebook Tests (pytest)

Located in `notebooks/tests/`. Config in `pytest.ini` (project root). Run with `make test-nb-all`.

**Credential Resolution Order** (`notebooks/utils/credentials.py`):
1. `ui/.env.local` — primary source (loaded with `override=False`)
2. `<project>/.env` — optional override (loaded with `override=True`)
3. Environment variables — for CI / container injection
4. `ELASTICSEARCH_URL` (UI key) is auto-mapped to `ELASTIC_URL` (notebook key)
5. Interactive `getpass` prompt — last resort (Colab, first-time users)

**Unit tests** (46 tests) — `test_credentials.py` + `test_parsing.py` + `test_inference.py` + `test_reader.py`:
- Credential fallback chain: UI env as base, notebook env as override, key name bridging
- `get_index_name()`, `get_inference_id()`, `_get_user_suffix()` naming logic (including PermissionError)
- `get_elasticsearch_client()` routing (URL vs Cloud ID)
- `parse_articles()` on fixture markdown: count, IDs, titles, body text, edge cases, language parameter
- `build_comparison()` ranking movement: up/down/same/NEW, title truncation, empty-input guard, dynamic label
- `verify_embedding_endpoint()`: confirms built-in `.jina-embeddings-v5-text-small` is available
- `create_reranker_inference()`: success, already-exists, re-raise
- `fetch_with_jina_reader()`: success, retry on empty, exhaustion, HTTP errors, auth headers

**Smoke tests** (3 tests) — `test_notebooks_smoke.py`:
- Executes each notebook via `nbclient` with injected mock cells
- Mocks `requests.get` (Jina Reader) and `elasticsearch.Elasticsearch`
- Sets credential env vars to skip interactive prompts
- Catches: import errors, broken cell ordering, Colab/local path logic regressions
- Uses content-pattern lookup (`_find_cell_index`) instead of hardcoded cell indices
- Path replacement includes assertion that at least one substitution occurred

**Integration tests** (4 tests) — `test_notebooks_integration.py`:
- Runs NB 01 → 02 → 03 sequentially via `papermill` against real services
- Skipped when no credentials found (checks `ui/.env.local`, `.env`, `ELASTIC_API_KEY` env var)
- Uses `USER_SUFFIX=pytest` to isolate from real user data
- Cleanup: deletes test index and inference endpoints after run
- Opt-in: `make test-nb-integration` (excluded from default `pytest` run via `addopts = -m "not integration"`)

### UI Unit Tests (Vitest + React Testing Library)

Located in `ui/__tests__/unit/`. Run with `npm test`.

**Lib tests** (`lib/`):
- `elasticsearch.test.ts` — Client singleton, `searchNaive` and `searchWithReranker` query construction with language filter, `checkIndexHealth` edge cases, `semantic_text` object structure handling
- `kibana.test.ts` — Kibana URL derivation (`.es.` → `.kb.` swap), explicit `KIBANA_URL`, trailing slash stripping, auth header construction, missing env var errors

**API route tests** (`api/`):
- `search.test.ts` — Request validation, naive vs reranked routing, language passthrough, error classification (503 for config, 503 for missing index, 500 for generic), timing
- `agent.test.ts` — Request validation, Kibana payload construction, German language prefix injection, conversationId passthrough, SSE stream headers, error proxying
- `followups.test.ts` — Request validation, Kibana connector call, JSON array parsing (message/choices fields, embedded text), truncation, German language, graceful degradation on failures
- `vision.test.ts` — FormData validation, Jina VLM payload construction, retry on 502/503/429, cold start response after retries exhausted, unexpected response shapes

**Component tests** (`components/`):
- `Header.test.tsx` — Brand rendering, language toggle forwarding, modal opening, reset callback
- `LanguageToggle.test.tsx` — EN/DE button rendering, active state highlighting, onChange callback
- `ModeToggle.test.tsx` — Search/Agent button rendering, active state, onChange callback
- `SearchBar.test.tsx` — Input rendering, form submission, loading/auditing states, image upload button
- `ResultCard.test.tsx` — Rank badge, article number, score, expand/collapse, source link, movement indicators (up/down/same/new), semantic_text object handling
- `ResultsList.test.tsx` — Naive results rendering, loading shimmer, empty state, comparison header, reranking impact stats
- `AgentChat.test.tsx` — Empty state EN/DE, suggestion pills + tooltips, input placeholders, image upload/preview, message sending, follow-up pill rendering/interaction/graceful failure
- `DeepAnalysisButton.test.tsx` — Label, loading state, disabled state, click handler
- `VlmAuditPanel.test.tsx` — Heading, expand/collapse toggle, analysis text display
- `EuAiActModal.test.tsx` — Content sections, EUR-Lex link, close button, Escape key, backdrop click
- `TomModal.test.tsx` — Name, title, quote, profile image, close button, Escape key, backdrop click

### E2E Tests (Playwright)

Located in `ui/__tests__/e2e/`. Run with `npm run test:e2e`. Requires the dev server running (auto-started via `webServer` config) or reuses an existing one on `localhost:3000`.

- `search-flow.spec.ts` — Empty state suggestions, search execution, result cards, expand/collapse, Deep Analysis reranking comparison, source links
- `agent-flow.spec.ts` — Agent mode switching, suggestion pills, chat message send, streaming response with thinking steps, image upload button
- `language-toggle.spec.ts` — EN/DE toggle, German suggestions in search + agent, English hover tooltips on German pills
- `modals.spec.ts` — EU AI Act modal open/close (button, Escape), EUR-Lex link, Tom Innocenti modal open/close

### Config Files

- `ui/vitest.config.ts` — Vitest config with React plugin, jsdom environment, `@/` path alias
- `ui/vitest.setup.ts` — Testing Library cleanup, `scrollTo` mock, global fetch stub
- `ui/playwright.config.ts` — Chromium project, `webServer` auto-start, 60s timeout

## Known Gotchas

1. **Jina VLM beta URL** — Must use `api-beta-vlm.jina.ai`, not `api.jina.ai`. The VLM model is on a separate beta endpoint.

2. **Embedding endpoint is built-in on Serverless** — `.jina-embeddings-v5-text-small` is pre-configured on Elastic Serverless. Do NOT call `inference.put()` for it; just reference it in mappings directly. Only the reranker endpoint still needs explicit creation via the `jinaai` service.

3. **Agent Builder `_getType` error** — Certain LLM connectors (e.g. `OpenAI-GPT-4-1-Mini`) trigger `Cannot read properties of undefined (reading '_getType')` when the agent's `index_search` tool queries a `semantic_text` field. Switching to `Google-Gemini-2-5-Flash` resolved this. This is a server-side connector compatibility issue, not a code bug.

4. **Agent PUT body must exclude `id`** — When updating an existing agent via `PUT /api/agent_builder/agents/{id}`, the `id` must NOT appear in the request body. Destructure it out before sending.

5. **SSE double-envelope** — Kibana Agent Builder SSE events wrap the payload: `data: {"data": {...actual payload...}}`. Parse the outer JSON, then access `.data` for the real content.

6. **Kibana URL derivation** — Only works when the ES URL contains `.es.` (standard for Elastic Cloud / Serverless). For non-standard deployments, set `KIBANA_URL` explicitly.

7. **Jina API key in EIS** — Must be in `service_settings.api_key`, not `secret_settings`, when creating inference endpoints via the ES `_inference` API.

## Maintaining This File

When completing a task that changes any of the following, update this file before finishing:

- Project structure (new files, directories, or major renames)
- Environment variables or credential handling
- Test infrastructure (new test files, changed test counts, new test commands)
- Naming conventions (index names, inference IDs, agent IDs)
- Architectural patterns or key integration details
- npm scripts, Makefile targets, or other developer commands
- New gotchas discovered during development

Keep entries concise and factual. Match the style of existing sections.

At the end of each major work session, add a "Current Status" section at the top of this file summarizing:

1. Recent accomplishments (what was just completed)
2. Any open issues or known bugs (what's still broken/pending)
3. Clear next step(s) to pick up in the following session (so it's immediately obvious what to tackle next)

Keep this section up to date to make it easy for anyone to see progress and know what's next at a glance.