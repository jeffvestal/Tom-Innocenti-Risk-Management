# Innocenti Risk Management - Enablement Kit

A field engineering enablement kit demonstrating the **"Full Chain" search pipeline** using **Jina AI models** on **Elastic Inference Service (EIS)**.

## The Scenario

We're simulating a high-stakes legal compliance firm called **"Innocenti & Associates"** that needs to search the **EU AI Act** with precision. Standard search fails on legal nuance -- we fix that with a complete pipeline:

1. **Jina Reader** → Converts messy PDFs to clean markdown
2. **Jina Embeddings v5** → Next-gen multilingual embeddings (built-in on Serverless)
3. **Jina Reranker v3** → Listwise precision (the "Lawyer's Brain")
4. **Jina VLM** → Vision Language Model that audits architecture diagrams for compliance risks

## Project Structure

The kit has two parts: **Python notebooks** for the data pipeline and a **Next.js UI** for the interactive demo.

```
├── notebooks/                   # Part 1: Data Pipeline (Python)
│   ├── 01_ingest.ipynb          #   PDF → Structured JSON via Jina Reader
│   ├── 02_index.ipynb           #   Index with semantic_text + EIS
│   ├── 03_rerank.ipynb          #   Demonstrate Listwise Reranking
│   ├── utils/
│   │   ├── credentials.py       #   Shared credential management
│   │   ├── parsing.py           #   Article parsing (extracted from NB 01)
│   │   └── comparison.py        #   Ranking comparison (extracted from NB 03)
│   └── tests/                   #   Notebook test suite (pytest)
│       ├── test_credentials.py  #   Credential management + fallback chain
│       ├── test_parsing.py      #   Article parsing + ranking comparison
│       ├── test_notebooks_smoke.py       # Notebook execution (mocked services)
│       └── test_notebooks_integration.py # Full pipeline (real services)
├── data/
│   └── eu_ai_act_clean.json     #   Generated by Notebook 01
│
├── ui/                          # Part 2: Interactive Demo (Next.js)
│   ├── app/
│   │   ├── page.tsx             #   Main search page
│   │   └── api/
│   │       ├── search/          #   Elasticsearch semantic search + reranking
│   │       ├── agent/           #   Kibana Agent Builder proxy (SSE)
│   │       │   └── followups/   #   LLM-generated follow-up question suggestions
│   │       ├── vision/          #   Jina VLM diagram auditor
│   │       │   └── warmup/      #   VLM cold-start warmup endpoint
│   │       └── ingest/          #   Data Lab SSE pipeline (GET status, POST ingest)
│   ├── components/              #   SearchBar, ResultsList, AgentChat, VlmAuditPanel, DataLab, etc.
│   ├── lib/
│   │   ├── elasticsearch.ts     #   ES client + search functions
│   │   └── ingest.ts            #   Shared Jina Reader ingestion logic
│   └── scripts/
│       ├── setup-demo-index.ts  #   Index creation + data loading (uses lib/ingest)
│       └── setup-agent.ts       #   Agent Builder tool + agent provisioning
│
└── requirements.txt             # Python dependencies
```

## Key Concepts Demonstrated

| Layer | Concept | Jina Product |
|-------|---------|--------------|
| Notebook 01 | PDF parsing without OCR | Jina Reader (ReaderLM) |
| Notebook 02 | Zero-config embeddings | Jina Embeddings v5 via EIS |
| Notebook 03 | Listwise reranking | Jina Reranker v3 via EIS |
| UI - Text Search | Semantic search + reranking | Jina Embeddings v5 + Reranker v3 via EIS |
| UI - Data Lab | Interactive ingestion pipeline visualization | Jina Reader (PDF → markdown → articles) |
| UI - Diagram Auditor | Architecture diagram analysis | Jina VLM (Vision Language Model) |
| UI - Agent Chat | RAG-powered EU AI Act compliance advisor | Kibana Agent Builder + LLM connector |

## Prerequisites

- Python 3.9+
- Node.js 18+
- Elastic Cloud account with API key
- Jina AI API key ([get one here](https://jina.ai/))

## Credentials

| Variable | Description |
|----------|-------------|
| `ELASTICSEARCH_URL` | Elasticsearch endpoint URL (standard for Serverless) |
| `ELASTIC_CLOUD_ID` | Alternative: classic Cloud deployment ID (if not using URL) |
| `ELASTIC_API_KEY` | API key with index/search permissions |
| `JINA_API_KEY` | Jina AI API key |
| `AGENT_CONNECTOR_ID` | Kibana LLM connector ID for Agent mode (see below) |

The UI accepts either `ELASTICSEARCH_URL` or `ELASTIC_CLOUD_ID` -- use whichever matches your deployment.

**Primary source:** `ui/.env.local` (copy from `ui/.env.local.example`). Both the UI and notebooks read from this file.

**Notebook override:** If you need different credentials for notebooks, create a root `.env` file. Values in `.env` override `ui/.env.local` for notebook runs only. The UI key `ELASTICSEARCH_URL` is automatically mapped to the notebook key `ELASTIC_URL`.

**First-time notebook users:** If no `.env.local` exists yet, notebooks prompt via `getpass` and offer to save to `.env`.

---

## Part 1: Notebooks (Data Pipeline)

### Setup

```bash
pip install -r requirements.txt
```

### Run the notebooks in order

1. **`01_ingest.ipynb`** - Fetches the EU AI Act PDF, cleans it, outputs JSON
2. **`02_index.ipynb`** - Creates Elastic index with `semantic_text`, bulk indexes data
3. **`03_rerank.ipynb`** - Demonstrates raw retrieval vs. reranked results

Each notebook prompts for credentials on first run. Save to `.env` for persistence across sessions.

---

## Part 2: UI (Interactive Demo)

### Setup

```bash
cd ui
npm install
cp .env.local.example .env.local   # then fill in credentials
```

### First-time data setup

If you haven't already loaded data via the notebooks, you can use the UI setup script:

```bash
npm run setup
```

This creates the search index, fetches the EU AI Act via Jina Reader, and indexes all articles.

### Start the dev server

```bash
npm run dev
```

Open [http://localhost:3000](http://localhost:3000).

### UI Features

**Text Search**
1. Enter a query like "biometric identification" or "law enforcement facial recognition"
2. View the top 10 semantically similar articles
3. Click "Deep Analysis" to trigger reranking with Jina Reranker v3
4. Compare results with movement indicators showing ranking changes

**Data Lab**

The Data Lab tab makes the Jina Reader ingestion pipeline visible and interactive instead of hiding it behind a CLI script. Use it to demonstrate how data flows from raw PDF to searchable index.

1. Switch to the **Data Lab** tab using the mode toggle
2. The Data Source card shows what's being ingested (EU AI Act, 180+ pages, EN/DE)
3. Enter a Jina API key or use the server-configured key (green badge)
4. Choose which language(s) to import: **EN**, **DE**, or **Both**
5. Click **Process Data** to start the pipeline
6. Watch the 5-step pipeline visualizer animate in real-time:
   - **Fetch PDF** → Jina Reader converts each PDF to markdown via `r.jina.ai`
   - **Parse Articles** → Regex splits markdown into individual articles
   - **Inference Endpoints** → Uses built-in Jina Embeddings v5 + creates Reranker v2 in Elasticsearch
   - **Index Documents** → Bulk indexes articles with automatic semantic embedding
   - **Complete** → Data is ready for search
7. After completion, the Data Preview section shows sample indexed articles with stats

> **Tip:** If data already exists, the preview loads immediately and the button shows "Re-process Data".

**Agent Chat**
1. Switch to the **Agent** tab using the mode toggle
2. Ask any question about the EU AI Act (e.g. "What are the prohibited AI practices?")
3. Upload an architecture diagram and ask "Are there any prohibited AI practices in this architecture?"
4. The agent searches the EU AI Act index, reasons through multiple articles, and produces a structured compliance assessment
5. After each response, contextual follow-up question pills appear -- click one to continue the conversation

> **Agent LLM Connector:** Set `AGENT_CONNECTOR_ID` in `.env.local`. Recommended: `OpenAI-GPT-4-1-Mini` (fastest, 25s) or `Anthropic-Claude-Opus-4-6` (most thorough, 90s). All Elastic-preconfigured `.inference` connectors are supported. Run `npm run setup:agent` after first setup.

**Visual Diagram Auditor**
1. Click the image icon next to the search bar and select an architecture diagram
2. Jina VLM analyzes the diagram and produces a detailed data-flow summary
3. Read the VLM Audit Report in the collapsible panel above results
4. The analysis is automatically used as a search query to surface relevant EU AI Act articles
5. Optionally click "Deep Analysis" to rerank the results

> **Note:** The Jina VLM has a ~45-second cold start after idle periods. The first upload may take up to a minute. If it fails, wait 30 seconds and try again.

### UI Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Browser                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Search | Agent | Data Lab  (mode toggle)                │   │
│  │  SearchBar, ResultsList, AgentChat, DataLab, etc.        │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Next.js Server                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  /api/search          - ES semantic search + rerank      │   │
│  │  /api/agent           - Kibana Agent Builder proxy (SSE) │   │
│  │  /api/agent/followups - LLM follow-up suggestions        │   │
│  │  /api/vision          - Jina VLM diagram analysis        │   │
│  │  /api/vision/warmup   - VLM cold-start warmup            │   │
│  │  /api/ingest          - Data Lab pipeline (SSE stream)   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┼──────────┐
                    ▼                    ▼
┌────────────────────────────┐  ┌────────────────────────────────┐
│       Elastic Cloud         │  │          Jina AI                │
│  search-eu-ai-act (index)  │  │  Reader (r.jina.ai)            │
│  Jina Embeddings v5 (EIS)  │  │  VLM (api-beta-vlm.jina.ai)   │
│  Jina Reranker v3 (EIS)    │  │                                │
└────────────────────────────┘  └────────────────────────────────┘
```

### UI Scripts

| Command | Description |
|---------|-------------|
| `npm run setup` | Create index and load EN + DE data (idempotent) |
| `npm run setup:de` | Ingest only German articles (skips EN) |
| `npm run setup:agent` | Provision Agent Builder tool + agent |
| `npm run dev` | Start development server |
| `npm run build` | Build for production |
| `npm run start` | Start production server |
| `npm test` | Run unit tests (Vitest) |
| `npm run test:watch` | Run unit tests in watch mode |
| `npm run test:e2e` | Run E2E browser tests (Playwright) |
| `npm run test:all` | Run all tests (unit + E2E) |

### Running Tests

The project includes tests for both the notebooks and the UI. A root `Makefile` provides shortcuts.

```bash
make test-all     # Run notebook + UI tests (excludes live integration tests)
```

---

#### Notebook Tests

Located in `notebooks/tests/`. Run with pytest from the project root.

There are three test layers, from fast to comprehensive:

**Unit tests** (34 tests, <1s) -- test credential management, article parsing, and ranking comparison logic in isolation with no external services:

```bash
make test-nb-unit
```

**Smoke tests** (3 tests, ~4s) -- execute each notebook end-to-end with mocked Jina and Elasticsearch services. Catches import errors, broken cell ordering, and Colab/local path logic regressions:

```bash
make test-nb-smoke
```

**Integration tests** (4 tests, ~3-5 min) -- run the full pipeline against real Jina and Elasticsearch services. Requires credentials in `ui/.env.local` (or root `.env`). Skipped automatically when no credentials are found. Uses `USER_SUFFIX=pytest` to isolate test data, and cleans up created indices/endpoints after the run:

```bash
make test-nb-integration
```

**Run unit + smoke together** (default, no real services needed):

```bash
make test-nb-all
```

| Layer | Tests | Speed | External Services | What it catches |
|-------|-------|-------|-------------------|----------------|
| Unit | 34 | <1s | None | Logic bugs in parsing, credentials, comparisons |
| Smoke | 3 | ~4s | Mocked | Broken imports, cell ordering, missing dependencies |
| Integration | 4 | ~3-5 min | Jina + Elasticsearch | API changes, index schema drift, end-to-end pipeline failures |

---

#### UI Tests

Located in `ui/__tests__/`. Run with npm from the `ui/` directory.

**Unit tests** (123 tests, ~2s) -- test components, API routes, and library functions in isolation with mocked external services:

```bash
cd ui && npm test
```

**E2E browser tests** (25 tests, ~12s) -- test the full application in a real Chromium browser with mocked API responses:

```bash
cd ui && npm run test:e2e
```

The E2E suite auto-starts the dev server if one isn't already running. If you already have `npm run dev` running, it reuses it.

**Run UI unit + E2E together:**

```bash
cd ui && npm run test:all
```

| Suite | File | What it verifies |
|-------|------|-----------------|
| Unit | `lib/elasticsearch.test.ts` | ES query construction, language filter, semantic_text handling |
| Unit | `lib/kibana.test.ts` | Kibana URL derivation, auth headers |
| Unit | `api/search.test.ts` | Validation, naive vs reranked routing, language passthrough |
| Unit | `api/agent.test.ts` | Validation, German prefix injection, SSE streaming, error handling |
| Unit | `api/followups.test.ts` | Follow-up question generation, connector payload, error handling |
| Unit | `api/vision.test.ts` | Image validation, Jina VLM calls, retry logic, cold start |
| Unit | `components/*.test.tsx` | All 11 UI components: rendering, interactions, state changes |
| E2E | `search-flow.spec.ts` | Search suggestions, results, expand/collapse, Deep Analysis |
| E2E | `agent-flow.spec.ts` | Agent chat, streaming response, thinking steps |
| E2E | `language-toggle.spec.ts` | EN/DE toggle, bilingual suggestions, hover tooltips |
| E2E | `modals.spec.ts` | EU AI Act and Tom Innocenti modals open/close |

### Sample Queries

- `"Can law enforcement use facial recognition?"` - Reranking surfaces specific exceptions
- `"biometric identification systems"` - Compare general vs specific matches
- `"AI system risk categories"` - See how articles are reordered by relevance

---

## Tech Stack

| Component | Technology |
|-----------|------------|
| Notebooks | Python, Jupyter |
| UI Framework | Next.js 14 (App Router) |
| Styling | Tailwind CSS (light/dark mode) |
| Icons | Lucide React |
| Search Backend | Elasticsearch with `semantic_text` |
| Agent | Kibana Agent Builder (ES|QL tool) |
| AI Models | Jina Reader, Embeddings v5, Reranker v3, VLM |

## Troubleshooting

**"Search index not found"** - Run `npm run setup` (from `ui/`) to create the index and load data.

**"Elasticsearch not configured"** - Ensure `ui/.env.local` exists with valid `ELASTIC_CLOUD_ID` and `ELASTIC_API_KEY`.

**"Jina Reader empty response"** - The PDF fetch sometimes needs retries. The setup script handles this automatically, but you may need to run it again.

**Vision Diagram Auditor times out** - The Jina VLM has a ~45s cold start after idle periods. The API route retries automatically (up to 3 attempts). If it still fails, wait 30 seconds and try again. Ensure `JINA_API_KEY` is set in `ui/.env.local`.

## License

MIT
